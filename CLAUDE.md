# 텔레그램 스팸 감지 봇 프로젝트 - CLAUDE.md

## 프로젝트 개요
이 프로젝트는 Cerebras AI (Llama-4-Scout) 모델을 사용하여 텔레그램 그룹의 스팸 메시지를 자동으로 감지하고 삭제하는 봇입니다.

## 핵심 기능
- **AI 기반 스팸 감지**: Cerebras AI를 활용한 고정밀도 스팸 분류
- **스마트 URL 분석**: Mozilla Readability로 링크 내용 실시간 분석
- **지능형 우선순위 시스템**: 비멤버/링크 메시지 우선 처리
- **SQLite 기반 화이트리스트**: 데이터베이스 기반 안전한 그룹 관리
- **스코프 기반 명령어 자동완성**: 사용자별 맞춤형 명령어 메뉴
- **조용한 스팸 삭제**: 필터링된 그룹에는 알림 없이 삭제
- **관리자 그룹 전용 로깅**: 상세한 스팸 활동 로그
- **실시간 그룹 정보**: 화이트리스트 표시 시 현재 그룹 이름 실시간 조회
- **재시도 메커니즘**: 네트워크 오류 자동 복구
- **상세한 로깅**: 한국시간 기준 구조화된 로그 시스템

## 프로젝트 구조
```
fuckyou-spam/
├── bot.js                    # 메인 봇 애플리케이션
├── package.json              # Node.js 의존성 관리
├── README.md                 # 프로젝트 문서
├── Dockerfile                # Docker 이미지 빌드
├── docker-compose.yml        # Docker Compose 설정
├── data/                     # 데이터 저장소
└── logs/                     # 로그 파일
    ├── combined.log          # 전체 로그
    ├── error.log             # 에러 로그
    └── spam-actions.log      # 스팸 활동 로그
```

## 핵심 파일 분석

### bot.js (메인 애플리케이션)
- **라이브러리**: node-telegram-bot-api, @cerebras/cerebras_cloud_sdk, winston, axios
- **핵심 기능**: 메시지 수신, 스팸 분류, 자동 삭제, 로깅
- **우선순위 시스템**: 비멤버(+10), 텔레그램 링크(+20), 일반 URL(+5)
- **큐 처리**: 고우선순위(1초), 일반(3초) 배치 처리
- **웹 콘텐츠 분석**: axios + JSDOM + Mozilla Readability

### package.json
- **메인 의존성**: 
  - `@cerebras/cerebras_cloud_sdk`: AI 모델 접근
  - `node-telegram-bot-api`: 텔레그램 봇 API
  - `winston`: 로깅 시스템
  - `@mozilla/readability`: 웹 콘텐츠 추출
  - `jsdom`: DOM 파싱
  - `axios`: HTTP 요청
- **개발 도구**: `nodemon` (개발 모드)
- **Node.js 버전**: >=18.0.0

## 개발 환경 설정

### 필수 환경변수
```env
TELEGRAM_BOT_TOKEN=           # 텔레그램 봇 토큰
CEREBRAS_API_KEY=             # Cerebras AI API 키
BOT_USERNAME=                 # 봇 사용자명
```

### 관리자 설정 (선택사항)
```env
ADMIN_USER_ID=                # 관리자 텔레그램 사용자 ID
ADMIN_GROUP_ID=               # 관리자 그룹 ID (양수/음수 자동 변환)
```

### 선택적 환경변수
```env
LOG_LEVEL=info                # 로그 레벨
WEBPAGE_FETCH_TIMEOUT=10000   # 웹페이지 가져오기 타임아웃
MAX_URLS_PER_MESSAGE=2        # 메시지당 분석할 URL 수
WEBPAGE_CONTENT_MAX_LENGTH=1000 # 웹페이지 내용 최대 길이
ALLOWED_CHAT_IDS=             # 기존 그룹 ID (마이그레이션용)
```

## 개발 명령어
```bash
# 개발 환경 실행
npm run dev

# 프로덕션 실행
npm start

# Docker 실행
docker-compose up -d

# 로그 확인
docker-compose logs -f
```

## 코드 아키텍처

### 메시지 처리 플로우
1. **메시지 수신**: bot.on('message') 이벤트 핸들러
2. **화이트리스트 확인**: SQLite DB에서 그룹 허용 여부 확인
3. **멤버십 확인**: isGroupMember() 함수로 그룹 멤버 여부 확인
4. **우선순위 계산**: calculateMessagePriority() 함수
5. **큐 분류**: 고우선순위/일반 큐로 분류
6. **배치 처리**: processMessageQueue() 함수
7. **AI 분석**: Cerebras AI로 스팸 분류
8. **조용한 삭제**: 필터링된 그룹에는 알림 없이 삭제
9. **관리자 알림**: 관리자 그룹에만 상세 로그 전송

### 데이터베이스 설계
- **SQLite 기반**: 경량 로컬 데이터베이스
- **화이트리스트 테이블**: chat_id, chat_title, chat_type, added_at, added_by
- **자동 마이그레이션**: 기존 환경변수에서 DB로 데이터 이전
- **Promise 기반**: 비동기 데이터베이스 작업

### 명령어 자동완성 시스템
- **스코프 기반**: 사용자별 맞춤형 명령어 메뉴
- **일반 사용자**: 기본 명령어 (4개)
- **관리자**: 전체 명령어 + 화이트리스트 관리 (8개)
- **동적 동기화**: /sync_commands로 수동 업데이트 가능

### 로깅 시스템
- **Winston 기반**: 구조화된 로그 포맷
- **한국시간 기준**: Asia/Seoul 타임존 적용
- **다중 출력**: 파일 + 콘솔
- **로그 레벨**: debug < info < warn < error
- **분류된 로그**: combined.log, error.log, spam-actions.log

### 보안 및 안정성
- **SQLite 화이트리스트**: 데이터베이스 기반 안전한 그룹 관리
- **관리자 권한**: ADMIN_USER_ID + ADMIN_GROUP_ID 이중 검증
- **재시도 메커니즘**: 네트워크 오류 자동 복구 (지수 백오프)
- **초기화 검증**: 봇 시작 시 텔레그램 API 연결 확인
- **그레이스풀 셧다운**: 프로세스 종료 시 DB 연결 정리

## 스팸 감지 기준
- **암호화폐/NFT/Web3 홍보**
- **불법 광고**
- **피싱 시도**
- **명백한 홍보/광고 콘텐츠**
- **맥락 없는 텔레그램 그룹 링크**

### 비멤버 메시지 정책 개선
- **내용 기반 판단**: 멤버십 상태가 아닌 메시지 내용으로 스팸 여부 결정
- **정상 참여 허용**: 비멤버도 일반적인 대화, 질문, 토론 참여 가능
- **홍보성 콘텐츠만 차단**: 명백한 광고/홍보 목적의 메시지만 스팸으로 분류
- **맥락 고려**: 텔레그램 링크도 대화 맥락에 적절하면 허용

## 개발 시 주의사항
1. **API 키 보안**: .env 파일을 절대 커밋하지 않음
2. **비용 관리**: Cerebras AI API 사용량 모니터링
3. **권한 확인**: 봇의 관리자 권한 및 메시지 삭제 권한 필요
4. **로그 모니터링**: 정기적인 로그 파일 확인
5. **오분류 처리**: AI 모델의 한계 인식

## 새로운 기능 (최신 업데이트)

### 1. SQLite 기반 화이트리스트 관리
- **데이터베이스 기반**: 환경변수에서 SQLite DB로 전환
- **실시간 관리**: /whitelist_add, /whitelist_remove 명령어
- **자동 마이그레이션**: 기존 ALLOWED_CHAT_IDS 데이터 자동 이전
- **영구 저장**: 봇 재시작 시에도 설정 유지

### 2. 스코프 기반 명령어 자동완성
- **일반 사용자**: start, help, status, chatid (4개)
- **관리자**: 전체 명령어 + 화이트리스트 관리 (8개)
- **동적 동기화**: /sync_commands로 수동 업데이트
- **개인화**: 사용자별 맞춤형 명령어 메뉴

### 3. 조용한 스팸 삭제
- **필터링된 그룹**: 스팸 삭제 시 알림 없음
- **관리자 그룹**: 상세한 삭제 로그만 전송
- **도배 방지**: 그룹 내 시끄러운 알림 제거

### 4. 향상된 에러 처리
- **재시도 메커니즘**: 네트워크 오류 자동 복구
- **지수 백오프**: 1초 → 2초 → 4초 간격 재시도
- **초기화 검증**: 봇 시작 시 텔레그램 API 연결 확인
- **그레이스풀 셧다운**: 안전한 프로세스 종료

### 5. 실시간 그룹 정보 표시
- **현재 그룹 이름**: 실시간으로 조회한 최신 그룹 이름 표시
- **이름 변경 감지**: 저장된 이름과 현재 이름이 다른 경우 구분 표시
- **접근 상태 확인**: 봇이 그룹에 접근 가능한지 실시간 확인
- **그룹 타입 표시**: 슈퍼그룹, 일반그룹, 개인채팅 구분
- **오류 메시지**: 접근 불가능한 그룹의 상세 오류 정보 제공

## 확장 가능성
- **다중 관리자 지원**: 복수 관리자 설정 기능
- **사용자 정의 필터**: 규칙 기반 필터 추가
- **통계 대시보드**: 스팸 감지 통계 시각화
- **웹 인터페이스**: 브라우저 기반 관리 패널
- **백업 시스템**: 삭제된 메시지 백업

## 테스트 및 디버깅
- **로그 레벨**: DEBUG 모드로 상세 로그 확인
- **큐 상태**: /status 명령어로 큐 상태 모니터링
- **그룹 ID**: /chatid 명령어로 그룹 ID 확인
- **화이트리스트**: /whitelist_list로 등록된 그룹 확인
- **명령어 동기화**: /sync_commands로 자동완성 업데이트
- **Docker 로그**: docker-compose logs로 컨테이너 로그 확인

## 성능 최적화
- **배치 처리**: 메시지 묶음 처리로 API 호출 최적화
- **우선순위 큐**: 중요 메시지 우선 처리
- **SQLite 인덱스**: 화이트리스트 조회 최적화
- **타임아웃 설정**: 웹페이지 가져오기 타임아웃 조정
- **메모리 관리**: 큐 크기 제한 및 주기적 정리

## 문제 해결 가이드
1. **봇이 메시지 삭제하지 않음**: 관리자 권한 및 화이트리스트 확인
2. **화이트리스트 관리 불가**: ADMIN_USER_ID, ADMIN_GROUP_ID 환경변수 확인
3. **명령어 자동완성 안됨**: /sync_commands 실행 후 재시도
4. **API 오류**: 환경변수 및 API 키 확인
5. **초기화 실패**: 텔레그램 봇 토큰 형식 확인
6. **Docker 오류**: 로그 확인 및 환경변수 점검