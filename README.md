# 텔레그램 스팸 메시지 감지 봇

Cerebras AI를 사용하여 텔레그램 그룹의 스팸 메시지를 자동으로 감지하고 삭제하는 봇입니다.

## 🚀 주요 기능

- **AI 기반 스팸 감지**: Cerebras AI (Llama-4-Scout) 모델을 사용하여 메시지 분류
- **스마트 URL 분석**: Mozilla Readability를 사용하여 링크된 웹페이지의 실제 내용을 분석
- **비멤버 우선 검열**: 그룹 멤버가 아닌 사용자의 메시지를 우선적으로 검사
- **링크 기반 우선순위**: 텔레그램 그룹 링크나 URL이 포함된 메시지 우선 처리
- **자동 삭제**: 스팸으로 분류된 메시지 자동 삭제
- **지능형 큐 관리**: 우선순위별 메시지 처리 (비멤버/링크 메시지는 1초, 일반 메시지는 3초)
- **상세 로깅**: 삭제된 메시지의 사용자 정보, 멤버십 상태, 링크 분석 등 모든 정보 기록
- **화이트리스트 보안**: 허용된 그룹에서만 작동
- **Docker 지원**: Docker Compose를 통한 간편한 배포

## 📋 설치 및 설정

### 1. 환경 설정

1. `.env` 파일을 설정하세요:
```bash
cp .env.example .env
```

2. `.env` 파일에 필요한 정보를 입력하세요:
```env
# 필수 설정
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
CEREBRAS_API_KEY=your_cerebras_api_key_here
BOT_USERNAME=your_bot_username

# 관리자 설정 (선택사항)
ADMIN_USER_ID=your_telegram_user_id_here
ADMIN_GROUP_ID=your_admin_group_id_here

# 선택적 설정
LOG_LEVEL=info
WEBPAGE_FETCH_TIMEOUT=10000
MAX_URLS_PER_MESSAGE=2
WEBPAGE_CONTENT_MAX_LENGTH=1000

# 기존 환경변수 (마이그레이션 목적 - 선택사항)
ALLOWED_CHAT_IDS=your_group_chat_id_1,your_group_chat_id_2
```

### 2. 텔레그램 봇 생성

1. [@BotFather](https://t.me/botfather)에게 `/newbot` 명령어를 보내세요
2. 봇 이름과 사용자명을 설정하세요
3. API 토큰을 받아 `.env` 파일에 입력하세요

### 3. Cerebras AI API 키 발급

1. [Cerebras Cloud](https://cloud.cerebras.ai/)에서 계정을 만드세요
2. API 키를 발급받아 `.env` 파일에 입력하세요

### 4. 관리자 설정

봇의 관리자 권한을 설정하는 방법입니다:

**관리자 사용자 ID 확인:**
1. 봇에게 개인 메시지로 `/chatid` 전송
2. 반환된 사용자 ID를 `.env` 파일의 `ADMIN_USER_ID`에 설정

**관리자 그룹 ID 확인:**
1. 관리자 그룹에 봇을 추가
2. 관리자 그룹에서 `/chatid` 명령어 실행
3. 반환된 그룹 ID를 `.env` 파일의 `ADMIN_GROUP_ID`에 설정

**설정 참고사항:**
- 관리자 설정은 선택사항입니다
- 두 값을 모두 설정해야 화이트리스트 관리 기능이 활성화됩니다
- 관리자 그룹에서만 화이트리스트 관리 명령어 사용 가능

### 5. 그룹 ID 확인 방법

그룹 ID를 확인하는 방법은 다음과 같습니다:

**방법 1: 봇 사용 (권장)**
1. 봇을 대상 그룹에 추가
2. 그룹에서 `/chatid` 명령어 실행
3. 표시된 채팅 ID를 복사

**방법 2: 웹 텔레그램 사용**
1. [web.telegram.org](https://web.telegram.org) 접속
2. 대상 그룹 선택
3. 주소창에서 그룹 ID 확인 (예: `#-1001234567890`에서 `-1001234567890`이 그룹 ID)

**방법 3: 봇 API 사용**
1. 봇을 그룹에 추가
2. 그룹에서 메시지 전송
3. `https://api.telegram.org/bot<BOT_TOKEN>/getUpdates` 호출하여 chat_id 확인

### 6. 환경변수 설명

| 환경변수 | 설명 | 기본값 | 필수여부 |
|---------|------|--------|----------|
| `TELEGRAM_BOT_TOKEN` | 텔레그램 봇 API 토큰 | - | 필수 |
| `CEREBRAS_API_KEY` | Cerebras AI API 키 | - | 필수 |
| `BOT_USERNAME` | 봇의 사용자명 (@제외) | - | 필수 |
| `ADMIN_USER_ID` | 관리자 텔레그램 사용자 ID | - | 선택 |
| `ADMIN_GROUP_ID` | 관리자 그룹 ID | - | 선택 |
| `LOG_LEVEL` | 로그 레벨 (debug, info, warn, error) | info | 선택 |
| `WEBPAGE_FETCH_TIMEOUT` | 웹페이지 가져오기 타임아웃 (ms) | 10000 | 선택 |
| `MAX_URLS_PER_MESSAGE` | 메시지당 처리할 최대 URL 개수 | 2 | 선택 |
| `WEBPAGE_CONTENT_MAX_LENGTH` | 웹페이지 내용 최대 길이 | 1000 | 선택 |
| `ALLOWED_CHAT_IDS` | 기존 그룹 ID (마이그레이션용) | - | 선택 |

## 🐳 Docker로 실행

### 방법 1: Docker Compose 사용 (권장)

```bash
# 빌드 및 실행
docker-compose up -d

# 로그 확인
docker-compose logs -f

# 중지
docker-compose down
```

### 방법 2: 직접 실행

```bash
# 의존성 설치
npm install

# 봇 실행
npm start

# 개발 모드 (nodemon 사용)
npm run dev
```

## 📁 프로젝트 구조

```
telegram-spam-bot/
├── bot.js              # 메인 봇 코드
├── package.json        # Node.js 프로젝트 설정
├── Dockerfile          # Docker 이미지 설정
├── docker-compose.yml  # Docker Compose 설정
├── .env.example        # 환경변수 템플릿
├── .env                # 환경변수 (사용자가 작성)
├── .gitignore          # Git 무시 파일
├── logs/               # 로그 파일 디렉토리
└── data/               # 데이터 저장 디렉토리
```

## 🔧 사용법

### 봇을 그룹에 추가

1. **그룹에 봇 추가**: 봇을 대상 그룹에 추가하고 관리자 권한을 부여하세요
2. **메시지 삭제 권한**: 봇에게 메시지 삭제 권한을 반드시 부여하세요
3. **그룹 ID 확인**: 그룹에서 `/chatid` 명령어로 그룹 ID를 확인하세요
4. **화이트리스트 등록**: 관리자 그룹에서 `/whitelist_add [그룹ID]` 명령어로 등록하세요

⚠️ **보안 기능**: 봇은 화이트리스트에 등록된 그룹에서만 작동하며, SQLite 데이터베이스로 안전하게 관리됩니다.

### 봇 명령어

**일반 명령어:**
- `/start` - 봇 소개 및 사용법 안내
- `/help` - 도움말 및 명령어 목록
- `/status` - 봇 상태 및 큐 대기 메시지 수 확인
- `/chatid` - 현재 그룹의 채팅 ID 확인
- `/ping` - 봇 응답 속도 측정

**관리자 명령어 (관리자 그룹에서만):**
- `/whitelist_add [그룹ID]` - 그룹을 화이트리스트에 추가
- `/whitelist_remove [그룹ID]` - 그룹을 화이트리스트에서 제거
- `/whitelist_list` - 화이트리스트 목록 확인 (실시간 그룹 정보 포함)
- `/sync_commands` - 봇 명령어 동기화

### 자동 기능

- 그룹 메시지를 실시간으로 모니터링
- **비멤버 메시지 우선 검사**: 그룹에 참여하지 않은 사용자의 메시지를 우선적으로 분석 (단, 내용 기반 판단)
- **링크 메시지 우선 처리**: 텔레그램 그룹 링크나 URL이 포함된 메시지를 빠르게 검사
- **지능형 우선순위 시스템**: 
  - 텔레그램 링크 + 비멤버: 최고 우선순위 (즉시 처리)
  - 일반 URL + 비멤버: 높은 우선순위 (1초 후 처리)
  - 비멤버 메시지: 높은 우선순위 (1초 후 처리)
  - 일반 메시지: 보통 우선순위 (3초 후 처리)
- 스팸으로 분류된 메시지 자동 삭제 (조용히)
- **관리자 그룹 알림**: 스팸 삭제 시 상세 로그를 관리자 그룹에만 전송
- **텔레그램 명령어 자동완성**: 사용자별 맞춤형 명령어 메뉴 제공
- **자동 재부팅**: 한국시간 기준 매일 자정/정오 자동 재시작
- **응답 속도 측정**: `/ping` 명령어로 봇 상태 실시간 확인
- 모든 활동을 상세 로그에 기록 (멤버십 상태, 링크 분석 포함)

## 📊 스팸 감지 기준

다음과 같은 메시지들이 스팸으로 분류됩니다:

**기본 스팸 유형:**
- 암호화폐(코인) 홍보
- NFT 홍보
- Web3 홍보
- 불법 광고 (불법 웹사이트, 서비스, 제품)
- 피싱 시도

**비멤버 메시지 정책:**
- 비멤버도 일반적인 대화나 토론 참여 가능
- 단, 명백한 홍보/광고 콘텐츠는 더 주의깊게 검사
- 텔레그램 그룹 링크의 경우 맥락에 따라 판단 (무차별 홍보만 차단)

### 🔗 스마트 URL 분석

URL이 포함된 메시지의 경우:

- **웹페이지 내용 추출**: Mozilla Readability를 사용하여 실제 웹페이지의 제목, 내용, 사이트명을 분석
- **컨텍스트 분석**: 링크 텍스트와 실제 웹페이지 내용이 일치하는지 확인
- **정당한 링크 보호**: 뉴스 기사, 교육 자료, 유용한 리소스는 스팸으로 분류되지 않음
- **의심스러운 콘텐츠 탐지**: 웹페이지 내용이 명확히 광고성이거나 의심스러운 경우에만 스팸으로 분류

이를 통해 정상적인 링크 공유가 잘못 삭제되는 것을 방지합니다.

## 📝 향상된 로깅 시스템

### 🕐 한국시간 기준 로깅
모든 로그는 한국시간(KST)으로 기록되며, 타임스탬프가 가장 앞에 표시됩니다.

### 📊 직관적인 로그 포맷
```
[2024-01-15 14:30:25] [INFO] [telegram-spam-bot] 🚀 텔레그램 스팸 감지 봇이 시작되었습니다
[2024-01-15 14:30:26] [WARN] [telegram-spam-bot] 🗑️ 스팸 메시지 삭제 완료
```

### 📁 로그 파일 분류
- `logs/combined.log` - 모든 활동 로그 (INFO, WARN, ERROR)
- `logs/error.log` - 오류 로그만 (ERROR)
- `logs/spam-actions.log` - 스팸 관련 활동만 (WARN 이상)

### 🏷️ 이모지 기반 로그 태그
- 🚀 봇 시작/설정
- ✅ 성공적인 작업
- 🔍 분석/검사 시작
- ⚡ 높은 우선순위 처리
- 🚨 텔레그램 링크 감지
- 🔗 URL 감지
- 🗑️ 스팸 메시지 삭제
- ❌ 실패/오류
- 💥 심각한 오류
- ⚠️ 경고

### 📋 상세 로그 정보
스팸으로 삭제된 메시지 로그에 포함되는 정보:
- **시간**: 한국시간 기준 정확한 삭제 시점
- **사용자**: ID, 사용자명, 그룹 멤버 여부
- **채팅방**: ID, 제목, 타입
- **메시지**: 내용 미리보기, 우선순위, URL 포함 여부
- **분석**: 텔레그램 링크 포함 여부, URL 개수
- **전체 데이터**: JSON 형태로 모든 상세 정보

### 📋 향상된 화이트리스트 관리
`/whitelist_list` 명령어는 실시간 그룹 정보를 포함하여 표시됩니다:

**표시 정보:**
- **현재 그룹 이름**: 실시간으로 조회한 최신 그룹 이름
- **저장된 이름**: 화이트리스트 추가 시 저장된 이름 (현재 이름과 다른 경우만)
- **접근 상태**: 봇이 그룹에 접근 가능한지 여부
- **그룹 타입**: 슈퍼그룹(🏢), 일반그룹(👥), 개인채팅(👤) 구분
- **오류 정보**: 접근 불가능한 그룹의 오류 메시지

**예시 출력:**
```
📋 화이트리스트 목록:

1. 새로운 그룹 이름
   📝 저장된 이름: 예전 그룹 이름
   🆔 ID: -1001234567890
   📅 추가일: 2024-01-15
   🏢 타입: supergroup

2. 접근 불가능한 그룹 ❌ 접근 불가
   ⚠️ 오류: Bot was kicked from the group chat
   🆔 ID: -1001234567891
   📅 추가일: 2024-01-10
   ❓ 타입: unknown

💡 실시간 그룹 정보가 반영된 목록입니다.
```

### 🚨 스팸 삭제 알림 시스템
스팸 메시지가 삭제되면 관리자 그룹에만 상세한 알림이 전송됩니다:

```
🚨 스팸 메시지 삭제 알림

🏠 그룹 정보:
• 그룹명: 테스트 그룹
• 그룹 ID: -1001234567890
• 그룹 타입: supergroup

👤 사용자 정보:
• 이름: 홍길동
• 사용자명: @spammer123
• 사용자 ID: 123456789
• 멤버 상태: 비멤버
• 언어: ko

📝 메시지 정보:
• 메시지 ID: 12345
• 우선순위: 25
• URL 포함: 예
• 텔레그램 링크: 예
• 내용: 암호화폐 투자 기회...

⏰ 시각 정보:
• 전송 시각: 2024-01-15 14:30:25
• 삭제 시각: 2024-01-15 14:30:28

⚡ 이 메시지는 AI에 의해 스팸으로 분류되어 자동 삭제되었습니다.
```

**특징:**
- 필터링된 그룹에는 알림 없음 (조용히 삭제)
- 관리자 그룹에만 상세 로그 전송
- 그룹 정보, 사용자 정보, 메시지 내용 모두 포함
- 한국시간 기준 정확한 시각 표시
- 우선순위 및 분석 정보 제공

## ⚠️ 주의사항

1. **권한 설정**: 봇이 메시지를 삭제하려면 그룹에서 관리자 권한이 필요합니다
2. **API 비용**: Cerebras AI API 사용에 따른 비용이 발생할 수 있습니다
3. **오분류**: AI 모델이 완벽하지 않으므로 정상 메시지가 삭제될 수 있습니다
4. **보안**: `.env` 파일의 API 키는 절대 공개하지 마세요

## 🔧 문제 해결

### 일반적인 문제

1. **봇이 메시지를 삭제하지 않음**
   - 봇에게 관리자 권한이 있는지 확인
   - 메시지 삭제 권한이 있는지 확인

2. **API 오류**
   - `.env` 파일의 API 키가 올바른지 확인
   - Cerebras AI 계정 상태 확인

3. **Docker 실행 오류**
   - `docker-compose logs` 명령어로 로그 확인
   - `.env` 파일이 올바르게 설정되었는지 확인

## 📄 라이선스

MIT License

## 🤝 기여

버그 리포트나 기능 요청은 이슈를 통해 제출해 주세요. 